name: Test Database Table with Liquibase (Container)

on:
  push:
    branches: [ main ]

jobs:
  test-db-table:
    runs-on: ubuntu-latest
    services:
      # Choose your desired database service (MySQL or PostgreSQL)
      db:
        image: mysql:8.0  # Replace with postgres:latest for PostgreSQL
        env:
          MYSQL_DATABASE: test_db
          MYSQL_USERNAME: root
          MYSQL_PASSWORD: password # Access from secrets (for MySQL)
          # Add similar environment variables for PostgreSQL if needed
          #  POSTGRES_PASSWORD: password  # Replace with a strong password (for PostgreSQL)
          # Add environment variables for additional database configurations if needed
        ports:
          - 3306:3306  # Map container port to runner port (for MySQL)
          - 5432:5432  # Map container port to runner port (for PostgreSQL)
    steps:
      - uses: actions/checkout@v3

      # Install Liquibase
      - name: Install Liquibase
        run: |
            sudo wget -O- https://repo.liquibase.com/liquibase.asc | gpg --dearmor > liquibase-keyring.gpg && \
            sudo cat liquibase-keyring.gpg | sudo tee /usr/share/keyrings/liquibase-keyring.gpg > /dev/null && \
            sudo echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/liquibase-keyring.gpg] https://repo.liquibase.com stable main' | sudo tee /etc/apt/sources.list.d/liquibase.list
            sudo apt-get update
            sudo apt-get install liquibase
            liquibase --version

      # Configure Liquibase connection details (using service information)
      - name: Configure Liquibase connection (MySQL)
        env:
          LIQUIBASE_URL: jdbc:mysql://db:3306/test_db  # Adjust for your database name
          LIQUIBASE_USERNAME: root  # Adjust username if needed
          LIQUIBASE_PASSWORD: password  # Access from secrets
        run: |
          echo "Configured Liquibase connection for MySQL"

    #   - name: Configure Liquibase connection (PostgreSQL)
    #     env:
    #       LIQUIBASE_URL: jdbc:postgresql://db:5432/test_db  # Adjust for your database name
    #       LIQUIBASE_USERNAME: postgres  # Adjust username if needed
    #       LIQUIBASE_PASSWORD: password  # Access from secrets
    #     run: |
    #       echo "Configured Liquibase connection for PostgreSQL"

      # Place your Liquibase changelog file
      - name: Download PostgreSQL JDBC Driver
        uses: actions/download-artifact@v3
        with:
          name: jdbc-driver-postgresql
          url: https://jdbc.postgresql.org/download/postgresql-42.3.6.jar

      - name: Move downloaded artifact
        run: |
            mv jdbc-driver-*.jar lib/  # Adjust the destination path (e.g., lib) as needed

      - name: Copy Liquibase changelog
        uses: actions/upload-artifact@v3
        with:
          name: liquibase-changelog
          path: database_change/changelog_v1.xml

      # Execute Liquibase update
      - name: Run Liquibase update
        run: |
          liquibase --changeLogFile @liquibase-changelog/changelog.xml  update  --url jdbc:mysql://localhost:3306/test_db

      # Verify table creation (adjust query based on your table name)
      - name: Verify table creation (MySQL)
        run: |
          mysql --host db -u root -ppassword -D test_db -e "SHOW TABLES LIKE 'testdb'" | grep your_table_name || exit 1

      - name: Verify table creation (PostgreSQL)
        run: |
          psql -h db -U postgres -d test_db -t -c "SELECT * FROM information_schema.tables WHERE table_name = 'testdb'" | grep your_table_name || exit 1
